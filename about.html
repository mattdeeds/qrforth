<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>qrforth</title>
        <link rel="icon" type="image/png" href="qrforth.png"/>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yegor256/tacit@gh-pages/tacit-css-1.6.0.min.css"/>
        <style>
            small {
                color: #4c4c4c;
            }
        </style>
    </head>
    <body>
        <section>
            <header>
                <nav>
                    <ul>
                        <li><img src="qrforth.png" alt="qrforth logo" style="max-height: 150px;"/></li>
                        <li><a href="https://qrforth.com/#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
                            ">Home</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="qrcode.html">QR Code</a></li>
                        <li><a href="examples.html">Examples</a></li>
                    </ul>
                </nav>
            </header>
            <article>
                <p>
                    <strong>qrforth</strong> is a tiny implementation of the <a href="https://en.wikipedia.org/wiki/Forth_(programming_language)">Forth</a> programming language that fits in a <a href="qrcode.html">QR code</a>. The heart of qrforth is a miniaturized <a href="https://www.rust-lang.org/">Rust</a> library compiled to <a href="https://webassembly.org/">WebAssembly</a> resulting in a ~1.3kB binary. The qrforth webassembly module is responsible for the Forth stack, primitive words, and functions that provide access to the stack and registers. Javascript is used to execute the webassembly, accept user input, and define new words. The size of all of this comes to ~2.8kB, just small enough to fit in a version 40 QR code (177x177) with the lowest level error correction. Visiting the Home page or scanning the QR code will run qrforth in your browser.
                </p>
                <h1>
                    How it Works
                </h1>
                <p>
                    The qrforth project consists of three main parts: the wasm module(lib.rs), the html/javascript code(qrforth.html), and the qrforth.com webpage(index.html). The wasm module is encoded in the qrforth.html page and the whole thing is encoded in the QR code. The url in the QR code needs to point to a resource on the web so the qrforth.com webpage is a simple static site hosted on <a href="https://pages.github.com/">GitHub Pages</a> that serves as a landing page and decodes the url contained in the QR Code.<br>
                    <br>
                    The url encoded in the QR code looks something like this <code>http://qrforth.com/#i9EKAICqqqrq/26XE5dDdph...</code> (truncated for readability, <a href="https://github.com/mattdeeds/qrforth/blob/main/url.txt">full URL here</a>). Using <a href="https://en.wikipedia.org/wiki/URI_fragment">URI fragments</a> the entire qrforth.html webpage is encoded in the URL itself. The qrforth.com webpage receives the URI fragment, decodes and decompresses it, and serves the resulting html as an iframe. All of this is done in the browser with no server side code. The following sections go into more detail on how each part of qrforth works.
                <p>
                    To compile our rust library to webassembly we use the <code>--target=wasm32-unknown-unknown --release</code> cargo build flags. We need to keep the resulting wasm binary as small as possible so we need to: 1) use the <code>#![no_std]</code> attribute to disable the standard library, 2) define a custom panic handler with <code>#[panic_handler]</code>, 3) statically allocate our variables to avoid brining in dlmalloc, and 4) strip and optimize our binary with the strip and lto setting in our Cargo.toml file. All of this will keep the rust compiler from adding in typically useful but sizeable code to our wasm binary. I've linked some super helpful resources below that go into more detail on how to do this.
                </p>
                <ul>
                    <li><a href="https://surma.dev/things/rust-to-webassembly/">Rust to WebAssembly the hard way</a>, Surma</li>
                    <li><a href="https://nickb.dev/blog/avoiding-allocations-in-rust-to-shrink-wasm-modules/">Avoiding allocations in rust to shrink wasm modules</a>, nickb</li>
                    <li><a href="https://darkcoding.net/software/a-very-small-rust-binary-indeed/">A very small rust binary indeed</a>, Graham King</li>
                </ul>
                <p>
                    Now what we have our qrforth.wasm binary, we can encode it as a base64 string and put it in our qrforth.html page. The javascript in qrforth.html will decode the base64 string and initialize the wasm module when the browser loads the page. The qrforth.html page is now complete and the URI fragment can be created by compressing the html with <a href="https://github.com/google/brotli">brotli</a> and encoding the result as a base64 string. The URL fragment is then appended to the qrforth.com url and the resulting url is encoded as a <a href="/qrcode.html">QR code</a>.<br>
                    <br>
                    All of these steps are automated with a build script that makes rebuilding as easy as running <code>./build.sh</code>. qrforth can also be run locally with a simple python sever and running <code>./build.sh --local</code>. More info can be found in the <a href="https://github.com/mattdeeds/qrforth">GitHub repository</a>.
                </p>
                <h1>
                    Forth Implementation
                </h1>
                <p>
                    The qrforth implementation of Forth is designed to be very minimal and only includes a limited subset of the language. Using the words provided, more useful words can be written in qrforth. Some examples are provided <a href="/examples.html">here</a>here. Don't expect qrforth to be a perfect implementation of Forth or ANS Forth compliant, there are already plenty of well designed implementations out there. The goal of qrforth is mainly just to learn more about Forth, WebAssembly, and Rust.<br>
                    The memory for the system is arbitrarily laid out as an array of 32-bit signed integers, 8000 elements in length. The first 4000 elements reserved for the Forth stack and the second 4000 is general system memory. There is a 8-bit <code>FLAGS</code> register that is used communicating state from the wasm module to the qrforth html page. User input and output and the Forth dictionary are handled by the page's javascript. The following is a list of the words that make up qrforth:
                    <table>
                        <thead>
                            <tr>
                                <th>Word</th>
                                <th>Definition</th>
                                <th>Stack Effect</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>push</code></td>
                                <td>Push x onto the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>+</code></td>
                                <td>Sum the two numbers at the top of the stack</td>
                                <td><i>( x y -- z )</i></td>
                            </tr>
                            <tr>
                                <td><code>nand</code></td>
                                <td>NAND the two numbers at the top of the stack</td>
                                <td><i>( x y -- z )</i></td>
                            </tr>
                            <tr>
                                <td><code>drop</code></td>
                                <td>Drop the number at the top of the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>0=</code></td>
                                <td>If top of stack is 0, set to -1, otherwise set to 0</td>
                                <td><i>( x -- flag )</i></td>
                            </tr>
                            <tr>
                                <td><code>@</code></td>
                                <td>Fetch memory contents at addr</td>
                                <td><i>( addr -- x )</i></td>
                            </tr>
                            <tr>
                                <td><code>!</code></td>
                                <td>Store x at addr</td>
                                <td><i>( x addr -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>sp@</code></td>
                                <td>Return stack top pointer to top of stack</td>
                                <td><i>( -- sp )</i></td>
                            </tr>
                            <tr>
                                <td><code>emit</code></td>
                                <td>Print x as an ASCII character</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>.</code></td>
                                <td>Print top of the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>key</code></td>
                                <td>Read a character and push it onto the stack</td>
                                <td><i>( -- x )</i></td>
                            </tr>
                            <tr>
                                <td><code>begin</code></td>
                                <td>Marks the start of a <strong>begin until</strong> loop</td>
                                <td><i>( -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>until</code></td>
                                <td>If x is zero, jumps to matching begin, if x is non-zero, continues execution </td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>if</code></td>
                                <td>If x is -1, continue execution within <strong>if then</strong> block.</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>then</code></td>
                                <td>Marks the end of an <strong>if then</strong> block</td>
                                <td><i>( -- )</i></td>
                            </tr>
                        </tbody>
                    </table>
                    In typical Forth fashion, colon (<code>:</code>) and semicolon (<code>;</code>) words are available and are used to define new words in the dictionary. Commenting code is supported using parentheses. You can easily define a new word like <code>dup</code> to duplicate the top value on the stack:<br>
                    <code>: dup ( x -- x x ) sp@ @ ;</code><br>
                </p>
                <h2>Inspired by these cool projects:</h2>
                <ul>
                    <li><a href="https://github.com/cesarblum/sectorforth">sectorforth</a></li>
                    <li><a href="https://github.com/skilldrick/easyforth">Easy Forth</a></li>
                    <li><a href="https://github.com/alcor/itty-bitty">itty.bitty</a></li>
                </ul>
            </article>
            <footer>
                <nav>
                    <ul>
                        <small>qrforth v0.1.0, 2023 Matthew Deeds, 
                            <a href="https://opensource.org/license/mit/">MIT License</a>
                        <br>
                        <a href="https://github.com/mattdeeds/qrforth">GitHub</a>
                        </small>
                    </ul>
                </nav>
            </footer>
        </section>
    </body>
</html>