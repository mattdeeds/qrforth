<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>qrforth</title>
        <link rel="icon" type="image/png" href="qrforth.png"/>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yegor256/tacit@gh-pages/tacit-css-1.6.0.min.css"/>
        <style>
            small {
                color: #4c4c4c;
            }
        </style>
    </head>
    <body>
        <section>
            <header>
                <nav>
                    <ul>
                        <li><img src="qrforth.png" alt="qrforth logo" style="max-height: 150px;"/></li>
                        <li><a href="https://qrforth.com/#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">home</a></li>
                        <li><a href="about.html">about</a></li>
                        <li><a href="qrcode.html">scan me</a></li>
                        <li><a href="examples.html">code examples</a></li>
                    </ul>
                </nav>
            </header>
            <article>
                <p>
                    <strong>qrforth</strong> is a tiny implementation of the <a href="https://en.wikipedia.org/wiki/Forth_(programming_language)">Forth</a> programming language that fits in a <a href="qrcode.html">QR code</a>. The heart of qrforth is a miniaturized <a href="https://www.rust-lang.org/">Rust</a> library compiled to <a href="https://webassembly.org/">WebAssembly</a> resulting in a ~1.3kB binary. The qrforth Rust library is responsible for the Forth stack, 11 primitive words, and API functions that allow the qrforth javascript code to easily access the state of the stack and registers. Javascript is used to initialize the webassembly module, accept user input, and define new words. The size of all of this comes to ~2.8kB, just small enough to fit in a version 40 QR code (177x177) with the lowest level error correction.
                </p>
                <h1>
                    How it Works
                </h1>
                <p>
                    The qrforth project consists of three main parts: the wasm module(lib.rs & qrforth.wasm), the html/javascript code(qrforth.html), and the qrforth.com webpage(index.html). The wasm module and html/javascript come together and are encoded in the QR code. The qrforth.com webpage is a simple static site hosted on <a href="https://pages.github.com/">GitHub Pages</a> that serves as a landing page and decodes qrforth.<br>
                    <br>
                    The url encoded in the QR code looks something like this <code>http://qrforth.com/#i9EKAICqqqrq/26XE5dDdph...</code> (truncated for readability). The qrforth wasm module is encoded in html/javascript page and the whole thing is compressed and encoded in the url using <a href="https://en.wikipedia.org/wiki/URI_fragment">URI fragments</a>. The qrforth.com webpage receives the URI fragment, decodes and decompresses it, and serves the resulting html as an iframe. All of this is done in the browser with no server side code. The following sections go into more detail on how each part of qrforth works.
                <p>
                    To compile our rust library to webassembly we use the <code>--target=wasm32-unknown-unknown --release</code> cargo build flags. We need to keep the resulting wasm binary as small as possible so we need to: 1) use the <code>#![no_std]</code> attribute to disable the standard library, 2) define a custom panic handler with <code>#[panic_handler]</code>, 3) statically allocate our variables to avoid brining in dlmalloc, and 4) strip and optimize our binary with the strip and lto setting in our Cargo.toml file. All of this will keep the rust compiler from adding in typically useful but sizeable code to our binary. I've linked some super helpful resources below that go into more detail on how to do this.
                </p>
                <ul>
                    <li><a href="https://surma.dev/things/rust-to-webassembly/">Rust to WebAssembly the hard way</a>, Surma</li>
                    <li><a href="https://nickb.dev/blog/avoiding-allocations-in-rust-to-shrink-wasm-modules/">Avoiding allocations in rust to shrink wasm modules</a>, nickb</li>
                    <li><a href="https://darkcoding.net/software/a-very-small-rust-binary-indeed/">A very small rust binary indeed</a>, Graham King</li>
                </ul>
                <p>
                    Now what we have our qrforth.wasm binary, we can encode it as a base64 string and put it in our qrforth.html page. The javascript in qrforth.html will decode the base64 string and initialize the wasm module when the browser loads the page. The qrforth.html page is now complete and the url fragment can be created by encoding the html as a base64 string and compressing it with <a href="https://github.com/google/brotli">brotli</a>. The URL fragment is then appended to the qrforth.com url and the resulting url is encoded as a <a href="/qrcode.html">QR code</a>.<br>
                    <br>
                    All of these steps are automated with a build script that makes rebuilding as easy as running <code>./build.sh</code>. qrforth can also be run locally with a simple python sever and running <code>./build.sh --local</code>. More info can be found in the <a href="https://github.com/mattdeeds/qrforth">GitHub repository</a>.
                </p>
                <h1>
                    Forth Implementation
                </h1>
                <p>
                    The qrforth implementation of Forth is inspired by <a href="https://github.com/cesarblum/sectorforth">sectorforth</a> which is designed to fit in a 512-byte boot sector. qrforth adds a few more words for convenience but otherwise is very minimal. Don't expect qrforth to be a perfect implementation of Forth or ANS Forth compliant, there are already plenty of well designed implementations out there. The goal of qrforth is mainly just to learn more about Forth, WebAssembly, and Rust.<br>
                    The memory for the system is arbitrarily laid out as an array of 32-bit signed integers, 8000 elements in length. The first 4000 elements reserved for the Forth stack and the second 4000 is general system memory. There is a 8-bit <code>FLAGS</code> register that is used communicating state from the wasm module to the qrforth html page. User input and output and the Forth dictionary are handled by the page's javascript. The following is a list of the 11 primitive words that make up qrforth:
                    <table>
                        <thead>
                            <tr>
                                <th>Word</th>
                                <th>Definition</th>
                                <th>Stack Effect</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>push</code></td>
                                <td>Push x onto the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>+</code></td>
                                <td>Sum the two numbers at the top of the stack</td>
                                <td><i>( x y -- z )</i></td>
                            </tr>
                            <tr>
                                <td><code>nand</code></td>
                                <td>NAND the two numbers at the top of the stack</td>
                                <td><i>( x y -- z )</i></td>
                            </tr>
                            <tr>
                                <td><code>drop</code></td>
                                <td>Drop the number at the top of the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>0=</code></td>
                                <td>If top of stack is 0, set to -1, otherwise set to 0</td>
                                <td><i>( x -- flag )</i></td>
                            </tr>
                            <tr>
                                <td><code>@</code></td>
                                <td>Fetch memory contents at addr</td>
                                <td><i>( addr -- x )</i></td>
                            </tr>
                            <tr>
                                <td><code>!</code></td>
                                <td>Store x at addr</td>
                                <td><i>( x addr -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>sp@</code></td>
                                <td>Return stack top pointer to top of stack</td>
                                <td><i>( -- sp )</i></td>
                            </tr>
                            <tr>
                                <td><code>emit</code></td>
                                <td>Print low byte of x as an ASCII character</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>.</code></td>
                                <td>Print top of the stack</td>
                                <td><i>( x -- )</i></td>
                            </tr>
                            <tr>
                                <td><code>key</code></td>
                                <td>Read a character and push it onto the stack</td>
                                <td><i>( -- x )</i></td>
                            </tr>
                        </tbody>
                    </table>
                    In typical Forth fashion, colon (<code>:</code>) and semicolon (<code>;</code>) words are available and are used to define new words in the dictionary. Commenting code is supported using parentheses. You can easily define a new word like <code>dup</code> to duplicate the top value on the stack:<br>
                    <code>: dup ( x -- x x ) sp@ @ ;</code><br>
                </p>
                <h2>Inspired by these cool projects:</h2>
                <ul>
                    <li><a href="https://github.com/cesarblum/sectorforth">sectorforth</a></li>
                    <li><a href="https://github.com/skilldrick/easyforth">Easy Forth</a></li>
                    <li><a href="https://github.com/alcor/itty-bitty">itty.bitty</a></li>
                </ul>
            </article>
            <footer>
                <nav>
                    <ul>
                        <small>qrforth v0.1.0, 2023 Matthew Deeds, 
                            <a href="https://opensource.org/license/mit/">MIT License</a>
                        <br>
                        <a href="https://github.com/mattdeeds/qrforth">GitHub</a>
                        </small>
                    </ul>
                </nav>
            </footer>
        </section>
    </body>
</html>